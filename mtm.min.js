/*
MetaTreeMap Copyright (c) 2015, Maxime HEBRARD for Laboratory for Integrated Bioinformatics, RIKEN, Japan.
All rights reserved.
see: https://github.com/mhebrard/MetaTreeMap/LICENSE for full details.
*/
!function(){function S(e){return new Promise(function(t){var n=document.createElement("script");n.type="text/javascript",n.src=e,n.onload=function(){return t(e+" loaded")},document.getElementById("mtm-mods").appendChild(n)})}function x(e,t){return new Promise(function(n){var r=document.createElement("link");r.rel="stylesheet",r.href=e,r.crossorigin="anonymous",t&&(r.id=t),r.onload=function(){return n(e+" loaded")},document.getElementById("mtm-mods").appendChild(r)})}function T(e){return new Promise(function(t){if(e)d3.json(e.data,function(e){return r=e,t("config file loaded")});else{if(!!r)return t("current config use");d3.json("./mtm-config.json",function(e){return r=e,t("default config loaded")})}})}function N(e){d3.select("#mtm-samples").text("");var t=d3.select("#mtm-samples").append("ul").attr("class","list-unstyled"),n=[];if(!e||e.length==0)n=["data/HuFS.json","data/HuFU.json"],t.append("li").text("#1.HuFS"),t.append("li").text("#2.HuFU");else for(var r=0;r<e.length;r++)t.append("li").text("#"+(r+1)+"."+e[r].name.replace(/\.[^/.]+$/,"")),n.push(e[r].data);i={name:"root",children:[],data:{hits:0,rank:"no rank",sample:0,color:"#ccc"},id:"1"},o=[i.id],u=[i];var s=[],a=Promise.resolve(s);return n.forEach(function(e,t){a=a.then(function(n){return C(e,t,n)})}),a=a.then(function(e){return e}),a}function C(e,t,n){return new Promise(function(r){d3.json(e,function(e){return n[t+1]=e.data.sum,k(e,"",t+1),r(n)})})}function k(e,t,r){e.id=(""+e.id).replace(/\s+/g,"_"),e.data.rank=="no rank"&&t!=""&&(e.data.rank=t.data.rank);var i,s=o.indexOf(e.id);if(s>-1){i=u[s];if(t!=""&&n.indexOf(t.data.rank)>n.indexOf(i.parent.data.rank)){i.parent.children.splice(i.parent.children.indexOf(i),1);var a=u[o.indexOf(t.id)];a.children.push(i)}}else{var a=u[o.indexOf(t.id)];i={name:e.name,children:[],parent:a,data:{hits:0,rank:e.data.rank,sample:0},id:e.id},a.children.push(i),o.push(i.id),u.push(i)}if(e.data.assigned!="0"){var f={name:e.name+" #"+r,children:[],data:{hits:+e.data.assigned,rank:e.data.rank,sample:r,percent:+e.data.assigned*100/m[r]},id:e.id};i.children.push(f)}if(e.children.length>0)for(var l in e.children)k(e.children[l],e,r,m)}function L(e,t){e.data.count=t.map(function(e){return 0});if(e.children.length>0)for(var n in e.children){var r=L(e.children[n],t);for(var i in r)e.data.count[i]+=r[i]}return e.data.count[e.data.sample]+=e.data.hits,e.data.hits=e.data.count.reduce(function(e,t){return e+t},0),e.data.percent=+e.data.hits*100/t[e.data.sample],e.data.count}function A(){return new Promise(function(e){var t=[];t=["rugged","flat"],t.indexOf(r.options.hierarchy)==0?r.options.hierarchy=!0:t.indexOf(r.options.hierarchy)==1&&(r.options.hierarchy=!1),t=["fluid","sticky"],t.indexOf(r.options.zoom)==0?r.options.zoom=!0:t.indexOf(r.options.zoom)==1&&(r.options.zoom=!1),t=["sample","hits","taxon"],t.indexOf(r.options.proportion)<0&&alert("please set config.options.proportion: "+t.toString()),t=["taxon","rank","sample","majority"],t.indexOf(r.options.colored)<0&&alert("please set config.options.colored: "+t.toString()),t=["colored","grayed"],t.indexOf(r.options.upper)==0?r.options.upper=!0:t.indexOf(r.options.upper)==1&&(r.options.upper=!1),t=["brewer","d3"],t.indexOf(r.options.palette)==0?r.options.palette=d[0][1]:t.indexOf(r.options.palette)==1&&(r.options.palette=d[1][1]),t=["black","white"],t.indexOf(r.options.background)==0?r.options.background=!0:t.indexOf(r.options.background)==1&&(r.options.background=!1),t=["taxon","rank","no"],t.indexOf(r.options.labelled)<0&&alert("please set config.options.labelled: "+t.toString()),e("Config checked")})}function O(){return new Promise(function(e){if(!d3.select("#mtm-mods").attr("data-hidden")){var t=d3.select("#mtm-mods").attr("data-hidden",!0);t.append("style").attr("type","text/css").text("<!--	#mtm-tip{position:absolute;z-index:3;background-color:#888;border:1px solid #000;border-radius:.2em;padding:3px;font-family:'Source Code Pro','Lucida Console',Monaco,monospace;font-size:14px;pointer-events:none;opacity:0}\n.mtm-table table{border-collapse:collapse;width:100%;}\n	-->"),t.append("div").attr("id","mtm-tip"),t.append("div").attr("id","mtm-canvas").style("display","none"),t.append("div").attr("id","mtm-samples").style("display","none");var n=t.append("div").attr("id","mtm-tags").attr("width","200px").style("display","none").append("ul").attr("class","list-unstyled");n.append("li").text("#N: Taxon Name"),n.append("li").text("#I: NCBI Taxonomy ID"),n.append("li").text("#H: Number Of Hits"),n.append("li").text("#R: Phylogenic Rank"),n.append("li").text("#S: Sample Number"),n.append("li").text("#P: % By Sample"),n.append("li").text("#V: % By View");var i=t.append("div").attr("id","mtm-modal").attr("class","modal fade").append("div").attr("class","modal-dialog").append("div").attr("class","modal-content"),s=i.append("div").attr("class","modal-header");s.append("button").attr("class","close").attr("type","button").attr("data-dismiss","modal").append("span").html("&times;"),s.append("h4").attr("class","modal-title").attr("id","mtm-modal-title");var o=i.append("div").attr("class","modal-body").attr("id","mtm-modal-body")}d3.selectAll(".mtm-menu").html(""),d3.selectAll(".mtm-treemap").html(""),d3.selectAll(".mtm-table").html(""),a=!1,f=!1,q(),r.table.display&&U(),r.treemap.display&&R(),e("Layout ready")})}function M(){l=i,D(i),_(),c=it(i,[]),K(),r.table.display&&(a?Q(a):Q(i)),r.treemap.display&&r.options.zoom&&(f=r.options.cutoff_rank!="init"?a:i);var e=c.reduce(function(e,t){return e.indexOf(t.id)<0&&e.push(t.id),e},[]);p=d3.scale.ordinal().range(r.options.palette.split(/\s*,\s*/)).domain(e),a?rt(a):rt(i),G()}function _(){if(r.options.cutoff_rank!="init"){var e=n.indexOf(r.options.cutoff_rank),t=n.indexOf(l.data.rank);e<=t&&(t++,r.options.cutoff_rank=n[t],d3.select("#mtm-bar-cutoff").node().value=r.options.cutoff_rank,e=t),a=P(e,i,i),D(a);var s=h.nodes().filter(function(e){return e.id==l.id&&e.data.sample==l.data.sample});l=s[0]}else a=!1}function D(e){r.treemap.display&&(m=+r.treemap.height-20,v=+r.treemap.width),h=d3.layout.treemap().size([v,m]).round(!1).sticky(!0).padding(function(){return r.options.hierarchy?2:0}).value(B(r.options.proportion));var n=h.nodes(e);g=d3.scale.linear().range([0,v]),y=d3.scale.linear().range([0,m]),t&&console.log("nodes",n.length,"leaves",n.filter(function(e){return!e.children}).length,"root.value",i.value)}function P(e,t,r){var i={name:r.name,children:[],data:{hits:+r.data.hits,rank:r.data.rank,sample:r.data.sample,percent:r.data.percent,color:r.data.color,count:r.data.count.slice(0)},id:r.id};if(n.indexOf(r.data.rank)==e)H(i,t,r.data.count);else{var s=r.data.count.map(function(e){return 0});if(r.children&&r.children.length>0){for(var o in r.children)if(r.children[o].data.sample==0){var u=n.indexOf(r.children[o].data.rank);u>e?s=s.map(function(e,t){return e+r.children[o].data.count[t]}):i.children.push(P(e,t,r.children[o]))}else s[r.children[o].data.sample]+=r.children[o].data.hits;H(i,t,s)}}return i}function H(e,t,n){for(var r in n)n[r]>0&&e.children.push({name:e.name+" #"+r,id:e.id,children:[],data:{hits:n[r],rank:e.data.rank,sample:r,percent:n[r]*100/t.data.count[r],color:e.data.color,count:e.data.count.map(function(e,t){return t==r?e:0})}})}function B(e){var t;return e=="sample"?t=j:e=="hits"?t=F:e=="taxon"?t=I:(console.log("ERROR: unvalide size mode"),t=j),t}function j(e){return e.data.percent}function F(e){return e.data.hits}function I(e){return 1}function q(){var s;s=d3.select(".mtm-menu").style("display","inline-block"),s.empty()&&(s=d3.select("body").append("div").attr("class","mtm-menu").style("display","none")),s.style("width")=="0px"&&s.style("width","100%");var o=s.append("nav").attr("class","navbar navbar-default").append("div").attr("class","container-fluid"),u=o.append("div").attr("class","navbar-header"),v=u.append("button").attr("type","button").attr("class","navbar-toggle collapsed").attr("data-toggle","collapse").attr("data-target","#mtm-barmenu");v.append("span").attr("class","icon-bar"),v.append("span").attr("class","icon-bar"),v.append("span").attr("class","icon-bar"),u.append("button").attr("type","button").attr("class","btn btn-default navbar-brand").attr("id","mtm-info").append("span").attr("class","glyphicon glyphicon-info-sign"),$("#mtm-info").popover({html:!0,content:function(){return $("#mtm-samples").html()},title:"Samples:"}),$("#mtm-info").tooltip({placement:"bottom",title:"Click to see sample names"}),$("#mtm-info").on({click:function(){$("#mtm-info").tooltip("hide")}}),u=o.append("div").attr("class","collapse navbar-collapse").attr("id","mtm-barmenu").append("ul").attr("class","nav navbar-nav"),v=u.append("li").attr("class","dropdown mtm-dropdown").attr("id","mtm-bar-import"),v.append("a").attr("href","#").attr("class","dropdown-toggle").attr("data-toggle","dropdown").html("Import <span class='caret'></span>"),m=v.append("ul").attr("class","dropdown-menu").style("width","350px").style("padding","5px"),g=m.append("li").attr("class","form-inline").style("white-space","nowrap").style("overflow","hidden").style("text-overflow","ellipsis"),g.append("label").text("Data File (JSON)").style("width","190px"),y=g.append("label").attr("class","btn btn-default").attr("id","mtm-data-btn").style("width","90px"),y.text("Browse..."),y.append("input").attr("type","file").style("display","none").attr("id","mtm-data-input").attr("name","dataFiles[]").property("multiple",!0).on("change",function(){var e=[];for(var t=0;t<this.files.length;t++)e.push(this.files[t].name);d3.select("#mtm-data-help").text(e.join(","))}),$("#mtm-data-btn").on({click:function(){$("#mtm-bar-import")[0].closable=!1}}),g.append("label").attr("class","help-block small").attr("id","mtm-data-help").style("display","inline"),g=m.append("li").attr("class","form-inline").style("white-space","nowrap").style("overflow","hidden").style("text-overflow","ellipsis"),g.append("label").text("Configuration File (JSON)").style("width","190px"),y=g.append("label").attr("class","btn btn-default").attr("id","mtm-config-btn").style("width","90px"),y.text("Browse..."),y.append("input").attr("type","file").style("display","none").attr("id","mtm-config-input").attr("name","confFiles[]").property("multiple",!0).on("change",function(){var e=[];for(var t=0;t<this.files.length;t++)e.push(this.files[t].name);d3.select("#mtm-config-help").text(e.join(","))}),$("#mtm-config-btn").on({click:function(){$("#mtm-bar-import")[0].closable=!1}}),g.append("label").attr("class","help-block small").attr("id","mtm-config-help").style("display","inline"),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","190px"),g.append("button").attr("class","btn btn-primary").attr("type","button").style("width","90px").text("Load").on("click",function(){var t=d3.select("#mtm-data-input").node().files,n=[];for(var r=0;r<t.length;r++)n.push({name:t[r].name,data:URL.createObjectURL(t[r])});var t=d3.select("#mtm-config-input").node().files,i="";t[0]&&(i={name:t[0].name,data:URL.createObjectURL(t[0])}),e.load(n,i)}),g=m.append("li").attr("class","divider"),g=m.append("li").attr("class","form-inline"),g.append("label").text("Convert Data File").style("width","190px"),y=g.append("label").attr("class","btn btn-default").attr("id","mtm-convert").style("width","90px").attr("data-toggle","modal").attr("data-target","#mtm-modal"),y.text("Format..."),$("#mtm-convert").on({click:function(){$("#mtm-bar-import")[0].closable=!1,X("convert")}}),v=u.append("li").attr("class","dropdown mtm-dropdown").attr("id","mtm-bar-colors"),v.append("a").attr("href","#").attr("class","dropdown-toggle").attr("data-toggle","dropdown").html("Colors <span class='caret'></span>");var m=v.append("ul").attr("class","dropdown-menu").style("width","300px").style("padding","5px"),g=m.append("li").attr("class","form-inline");g.append("label").style("width","120px").text("Color By");var y=g.append("select").attr("class","form-control").attr("id","mtm-bar-colored").style("width","120px");y.append("option").attr("value","taxon").text("Taxon"),y.append("option").attr("value","rank").text("Rank"),y.append("option").attr("value","sample").text("Sample"),y.append("option").attr("value","majority").text("Majority"),y.property("value",r.options.colored),y.on("change",function(){r.options.colored=this.value,d3.select("#mtm-bar-colored-block").classed("in",function(){return r.options.colored=="rank"?!0:!1}),G()}),$("#mtm-bar-colored").on({click:function(){$("#mtm-bar-colors")[0].closable=!1}}),g=m.append("li").attr("class","collapse").attr("id","mtm-bar-colored-block");var b=g.append("div").attr("class","form-inline");b.append("label").style("width","120px").text("Phylogenic Rank"),y=b.append("select").attr("class","form-control").attr("id","mtm-bar-colored-rank"),y.append("option").attr("value","init").text("Select...");for(var w in n)y.append("option").attr("value",n[w]).text(n[w]);y.property("value",r.options.colored_rank),y.on("change",function(){r.options.colored_rank=this.value,G()}),$("#mtm-bar-colored-rank").on({click:function(){$("#mtm-bar-colors")[0].closable=!1}}),b=g.append("div").attr("class","form-inline"),b.append("label").style("width","120px").text("Upper Ranks"),b.append("input").attr("type","checkbox").attr("id","mtm-bar-upper").attr("data-toggle","toggle").attr("data-on","colored").attr("data-off","grayed").attr("data-width","80").property("checked",function(){return r.options.upper}),$("#mtm-bar-upper").on({change:function(){$("#mtm-bar-colors")[0].closable=!1,r.options.upper=d3.select("#mtm-bar-upper").property("checked"),G()}}),g=m.append("li").attr("class","divider"),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","120px").text("Palette"),y=g.append("select").attr("class","form-control").attr("id","mtm-bar-palette").style("width","120px");for(var w in d)y.append("option").attr("value",d[w][1]).text(d[w][0]);y.property("value",r.options.palette),y.on("change",function(){r.options.palette=this.value,p=d3.scale.ordinal().range(r.options.palette.split(/\s*,\s*/)),G()}),$("#mtm-bar-palette").on({click:function(){$("#mtm-bar-colors")[0].closable=!1}}),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","120px").text("Background"),g.append("input").attr("type","checkbox").attr("id","mtm-bar-background").attr("data-toggle","toggle").attr("data-on","black").attr("data-off","white").attr("data-width","80").property("checked",function(){return r.options.background}),$("#mtm-bar-background").on({change:function(){$("#mtm-bar-colors")[0].closable=!1,r.options.background=d3.select("#mtm-bar-background").property("checked"),d3.selectAll(".mtm-bg").attr("fill",function(){return r.options.background?"#000":"#FFF"}),d3.selectAll(".mtm-header rect").style("stroke",function(){return r.options.background?"#000":"#FFF"}),d3.selectAll(".mtm-view rect").style("stroke",function(){return r.options.background?"#000":"#FFF"}),d3.select(".mtm-table").style("background-color",function(){return r.options.background?"#000":"#FFF"})}}),v=u.append("li").attr("class","dropdown mtm-dropdown").attr("id","mtm-bar-labels"),v.append("a").attr("href","#").attr("class","dropdown-toggle").attr("data-toggle","dropdown").html("Labels <span class='caret'></span>"),m=v.append("ul").attr("class","dropdown-menu").style("width","300px").style("padding","5px"),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","120px").text("Label By"),y=g.append("select").attr("class","form-control").attr("id","mtm-bar-labelled").style("width","120px"),y.append("option").attr("value","taxon").text("Taxon"),y.append("option").attr("value","rank").text("Rank"),y.append("option").attr("value","no").text("No Label"),y.property("value",r.options.labelled),y.on("change",function(){r.options.labelled=this.value,d3.select("#mtm-bar-labelled-block").classed("in",function(){return r.options.labelled=="rank"?!0:!1}),J(l)}),$("#mtm-bar-labelled").on({click:function(){$("#mtm-bar-labels")[0].closable=!1}}),g=m.append("li").attr("class","collapse").attr("id","mtm-bar-labelled-block"),b=g.append("div").attr("class","form-inline"),b.append("label").style("width","120px").text("Phylogenic Rank"),y=b.append("select").attr("class","form-control").attr("id","mtm-bar-labelled-rank"),y.append("option").attr("value","init").text("Select...");for(var w in n)y.append("option").attr("value",n[w]).text(n[w]);y.property("value",r.options.labelled_rank),y.on("change",function(){r.options.labelled_rank=this.value,J(l)}),$("#mtm-bar-labelled-rank").on({click:function(){$("#mtm-bar-labels")[0].closable=!1}}),g=m.append("li").attr("class","divider"),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","120px").text("Label Format"),b=g.append("div").attr("class","input-group"),b.append("input").attr("class","form-control").attr("id","mtm-bar-pattern").attr("type","text").style("width","120px").property("value",r.options.pattern).on("change",function(){r.options.pattern=this.value,J(l)}),$("#mtm-bar-pattern").on({click:function(){$("#mtm-bar-labels")[0].closable=!1}}),b.append("div").attr("class","input-group-btn").append("button").attr("type","button").attr("class","btn btn-default").attr("id","mtm-pattern").append("span").attr("class","glyphicon glyphicon-info-sign"),$("#mtm-pattern").on({click:function(){$("#mtm-pattern").tooltip("hide"),$("#mtm-bar-labels")[0].closable=!1}}),$("#mtm-pattern").popover({html:!0,content:function(){return $("#mtm-tags").html()},title:"Formatting Tags:",container:"#mtm-barmenu"}),$("#mtm-pattern").tooltip({placement:"bottom",container:"#mtm-barmenu",title:"Click to see a list allowed tags"}),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","120px").text("Font Size"),y=g.append("select").attr("class","form-control").attr("id","mtm-bar-font").style("width","120px");for(var E=8;E<40;E+=2)y.append("option").attr("value",E).text(E);y.property("value",r.options.font),y.on("change",function(){r.options.font=this.value,d3.selectAll(".mtm").style("font-size",r.options.font+"px"),d3.select("#mtm-tip").style("font-size",r.options.font+"px")}),$("#mtm-bar-font").on({click:function(){$("#mtm-bar-labels")[0].closable=!1}}),v=u.append("li").attr("class","dropdown mtm-dropdown").attr("id","mtm-bar-treemap"),v.append("a").attr("href","#").attr("class","dropdown-toggle").attr("data-toggle","dropdown").html("Treemap <span class='caret'></span>"),m=v.append("ul").attr("class","dropdown-menu").style("width","300px").style("padding","5px"),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","120px").text("Hierarchy"),g.append("input").attr("type","checkbox").attr("id","mtm-bar-hierarchy").attr("data-toggle","toggle").attr("data-on","rugged").attr("data-off","flat").attr("data-width","80").property("checked",function(){return r.options.hierarchy}),$("#mtm-bar-hierarchy").on({change:function(){$("#mtm-bar-treemap")[0].closable=!1,r.options.hierarchy=d3.select("#mtm-bar-hierarchy").property("checked"),h.padding(function(){return r.options.hierarchy?2:0}),a?h.nodes(a):h.nodes(i),rt(l)}}),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","120px").text("Zoom Transition"),g.append("input").attr("type","checkbox").attr("id","mtm-bar-zoom").attr("data-toggle","toggle").attr("data-on","fluid").attr("data-off","sticky").attr("data-width","80").property("checked",function(){return r.options.zoom}),$("#mtm-bar-zoom").on({change:function(){$("#mtm-bar-treemap")[0].closable=!1,r.options.zoom=d3.select("#mtm-bar-zoom").property("checked"),r.options.zoom?f=a?a:i:(f=!1,a?D(a):D(i)),rt(l)}}),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","120px").text("Proportion By"),y=g.append("select").attr("class","form-control").attr("id","mtm-bar-proportion").style("width","120px"),y.append("option").attr("value","sample").text("Sample"),y.append("option").attr("value","hits").text("Hits"),y.append("option").attr("value","taxon").text("Taxon"),y.property("value",r.options.proportion),y.on("change",function(){r.options.proportion=this.value,h.value(B(r.options.proportion)),a?h.nodes(a):h.nodes(i),rt(l)}),$("#mtm-bar-proportion").on({click:function(){$("#mtm-bar-treemap")[0].closable=!1}}),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","120px").text("Rank Cutoff:");var y=g.append("select").attr("class","form-control").attr("id","mtm-bar-cutoff");y.append("option").attr("value","init").text("Select...");for(var w in n)y.append("option").attr("value",n[w]).text(n[w]);y.property("value",r.options.cutoff_rank),y.on("change",function(){r.options.cutoff_rank=this.value,_(),a?Q(a):Q(i),r.options.zoom&&(f=a?a:i),G(),rt(l)}),$("#mtm-bar-cutoff").on({click:function(){$("#mtm-bar-treemap")[0].closable=!1}}),g=u.append("li").append("div").attr("class","navbar-form form-inline").append("div").attr("class","input-group btn-group"),g.append("div").attr("class","input-group-addon").attr("data-toggle","tooltip").attr("data-placement","bottom").attr("title","Go to node").append("span").attr("class","glyphicon glyphicon-search"),g.append("button").attr("type","button").attr("class","btn btn-default").on("click",function(){return a?rt(a):rt(i)}).attr("data-toggle","tooltip").attr("data-placement","bottom").attr("data-container","#mtm-barmenu").attr("title","Go to root node").text("Root"),g.append("button").attr("type","button").attr("class","btn btn-default").on("click",function(){return l.parent?nt(l.parent):rt(l)}).attr("data-toggle","tooltip").attr("data-placement","bottom").attr("data-container","#mtm-barmenu").attr("title","Go to parent node").text("Parent");var y=g.append("select").attr("class","selectpicker").attr("data-live-search","true").attr("data-width","120px");y.on("change",function(){var e=this.value<0?i:c[this.value];if(a){var t=it(a,[]).filter(function(t){return t.id==e.id&&t.data.sample==0});t.length>0?l=t[0]:(l=e,_(),a?Q(a):Q(i),r.options.zoom&&(f=a?a:i))}else l=e;G(),rt(l)}),v=u.append("li").attr("class","dropdown mtm-dropdown").attr("id","mtm-bar-layout"),v.append("a").attr("href","#").attr("class","dropdown-toggle").attr("data-toggle","dropdown").html("Layout <span class='caret'></span>"),m=v.append("ul").attr("class","dropdown-menu").style("width","190px").style("padding","5px"),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","90px").text("Treemap"),g.append("input").attr("type","checkbox").attr("id","mtm-bar-treemap-display").attr("data-toggle","toggle").attr("data-on","display").attr("data-off","hide").attr("data-width","80").property("checked",function(){return r.treemap.display}),$("#mtm-bar-treemap-display").on({change:function(){$("#mtm-bar-layout")[0].closable=!1,r.treemap.display=d3.select("#mtm-bar-treemap-display").property("checked"),d3.select("#mtm-bar-treemap-block").classed("in",r.treemap.display)}}),g=m.append("li").attr("class","collapse").attr("id","mtm-bar-treemap-block").classed("in",r.treemap.display),b=g.append("div").attr("class","form-inline"),b.append("label").style("width","90px").text("Width (px)"),b.append("input").attr("type","text").style("width","80px").attr("class","form-control").attr("id","mtm-bar-treemap-width").attr("value",r.treemap.width).on("change",function(){r.treemap.width=this.value}),$("#mtm-bar-treemap-width").on({click:function(){$("#mtm-bar-layout")[0].closable=!1}}),b=g.append("div").attr("class","form-inline"),b.append("label").style("width","90px").text("Height (px)"),b.append("input").attr("type","text").style("width","80px").attr("class","form-control").attr("id","mtm-bar-treemap-height").attr("value",r.treemap.height).on("change",function(){r.treemap.height=this.value}),g=m.append("li").attr("class","divider"),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","90px").text("Table"),g.append("input").attr("type","checkbox").attr("id","mtm-bar-table-display").attr("data-toggle","toggle").attr("data-on","display").attr("data-off","hide").attr("data-width","80").property("checked",function(){return r.table.display}),$("#mtm-bar-table-display").on({change:function(){$("#mtm-bar-layout")[0].closable=!1,r.table.display=d3.select("#mtm-bar-table-display").property("checked"),d3.select("#mtm-bar-table-block").classed("in",r.table.display)}}),g=m.append("li").attr("class","collapse").attr("id","mtm-bar-table-block").classed("in",r.table.display),b=g.append("div").attr("class","form-inline"),b.append("label").style("width","90px").text("Width (px)"),b.append("input").attr("type","text").style("width","80px").attr("class","form-control").attr("id","mtm-bar-table-width").attr("value",r.table.width).on("change",function(){r.table.width=this.value}),$("#mtm-bar-table-width").on({click:function(){$("#mtm-bar-layout")[0].closable=!1}}),b=g.append("div").attr("class","form-inline"),b.append("label").style("width","90px").text("Height (px)"),b.append("input").attr("type","text").style("width","80px").attr("class","form-control").attr("id","mtm-bar-table-height").attr("value",r.table.height).on("change",function(){r.table.height=this.value}),g=m.append("li").attr("class","divider"),g=m.append("li").attr("class","form-inline"),g.append("label").style("width","90px"),g.append("button").attr("class","btn btn-primary").attr("type","button").style("width","80px").text("Load").on("click",function(){O(),M()}),v=u.append("li").attr("class","dropdown mtm-dropdown").attr("id","mtm-bar-export"),v.append("a").attr("href","#").attr("class","dropdown-toggle").attr("data-toggle","dropdown").html("Export <span class='caret'></span>"),m=v.append("ul").attr("class","dropdown-menu"),g=m.append("li").append("a").attr("href","#").text("Data file in JSON format").on("click",function(){return e.save("json")}),g=m.append("li").append("a").attr("href","#").text("Treemap image in SVG format").on("click",function(){return e.save("svg")}),g=m.append("li").append("a").attr("href","#").text("Treemap image in PNG format").on("click",function(){return e.save("png")}),g=m.append("li").append("a").attr("href","#").text("Table data in TSV format").on("click",function(){return e.save("txt")}),g=m.append("li").append("a").attr("href","#").text("MTM configuration file in JSON format").on("click",function(){return e.save("config")}),v=u.append("li").attr("class","dropdown mtm-dropdown").attr("id","mtm-bar-about"),v.append("a").attr("href","#").attr("class","dropdown-toggle").attr("data-toggle","dropdown").html("About <span class='caret'></span>"),m=v.append("ul").attr("class","dropdown-menu").style("width","160px").style("padding","5px"),g=m.append("li").append("a").attr("href","html/documentation.htm").attr("target","mtm-doc").text("User Guide"),g=m.append("li").append("a").attr("href","html/feedback.htm").attr("target","mtm-feedback").text("Feedback"),g=m.append("li").append("a").attr("href","#").attr("data-toggle","modal").attr("data-target","#mtm-modal").text("Examples").on("click",function(){return X("examples")}),g=m.append("li").append("a").attr("href","#").attr("data-toggle","modal").attr("data-target","#mtm-modal").text("About MTM").on("click",function(){return X("about")}),$(function(){$('[data-toggle="toggle"]').bootstrapToggle()}),$(function(){$('[data-toggle="popover"]').popover()}),$(function(){$('[data-toggle="tooltip"]').tooltip()}),$(function(){$(".selectpicker").selectpicker()}),$(".mtm-dropdown").on({"show.bs.dropdown":function(){this.closable=!0},"hide.bs.dropdown":function(){return this.closable?!0:(this.closable=!0,!1)}}),$("body").on("click",function(e){$("#mtm-info,#mtm-pattern").each(function(){!$(this).is(e.target)&&$(this).has(e.target).length===0&&$(".popover").has(e.target).length===0&&$(this).popover("hide")})}),t&&console.timeEnd("bar")}function R(){t&&console.time("treemap");var e=d3.select(".mtm-treemap").append("svg").attr("class","mtm").attr("height",r.treemap.height).attr("width",r.treemap.width).style("font-family","'Source Code Pro','Lucida Console',Monaco,monospace").style("font-size",r.options.font+"px").style("display","inline-block").style("position","relative").style("z-index","1");e.append("rect").attr("width","100%").attr("height","100%").attr("fill",function(){return r.options.background?"#000":"#FFF"}).attr("class","mtm-bg"),e.append("g").attr("transform","translate(1,20)").classed("mtm-view",!0),e.append("g").attr("transform","translate(1,20)").classed("mtm-labels",!0);var n=e.append("g").attr("transform","translate(1,20)").classed("mtm-header",!0).style("font-size","14px");n.append("rect").attr("y",-20).attr("width",r.treemap.width).attr("height",20).style("fill","#888").style("stroke",function(){return r.options.background?"#000":"#FFF"}).style("cursor","pointer"),n.append("text").attr("x",6).attr("y",-16).attr("dy",".75em").style("pointer-events","none").text("Data loading..."),e.append("rect").classed("mtm-hl",!0).style("stroke","#000").style("stroke-width","5").style("fill","none").style("pointer-events","none"),t&&console.timeEnd("treemap")}function U(){t&&console.time("table");var e=d3.select(".mtm-table").append("div").attr("class","mtm").style("height",r.table.height).style("width",r.table.width).style("overflow","auto").style("font-family","'Source Code Pro','Lucida Console',Monaco,monospace").style("font-size",r.options.font+"px").style("background-color",function(){return r.options.background?"#000":"#FFF"}).style("display","inline-block").style("position","relative").style("z-index","1"),n=e.append("div").style("background-color","#888").append("table").append("tr").classed("mtm-header",!0).style("font-size","14px");n.append("th").text("Node"),n.append("th").style("width","70px").style("text-align","right").text("Taxon_ID"),n.append("th").style("width","60px").style("text-align","right").text("Hits"),n.append("th").style("width","60px").style("text-align","right").text("%/View"),n.append("th").style("width","90px").style("text-align","right").html("%/Sample&nbsp;"),n.append("th").style("width","130px").style("text-align","left").text("Rank"),n.append("th").style("width","15px").text("");var i=e.append("div").style("height",r.table.height-n.node().offsetHeight+"px").style("width",r.table.width+"px").style("overflow","auto").attr("class","mtm-scrollable").append("table").classed("mtm-view",!0).classed("mtm-labels",!0).style("table-layout","fixed");t&&console.timeEnd("table")}function z(e,t){e=="show"?d3.select("#mtm-tip").datum(t).style("opacity",1).html(function(e){return e.name+"<br/>Taxonomy ID: "+(+e.id>0?e.id:"")+"<br/>Rank: "+e.data.rank+"<br/>"+at(e.data.hits)+" hits"+"<br/>"+e.data.percent.toFixed(2)+"% of sample "+e.data.sample+"<br/>"+(e.value*100/l.value).toFixed(2)+"% of the view"}):e=="hide"?d3.select("#mtm-tip").style("opacity",0):d3.select("#mtm-tip").style("top",d3.event.pageY+10+"px").style("left",d3.event.pageX+10+"px")}function W(e){E==e?E="":E=e}function X(t){if(t=="convert")d3.select("#mtm-modal-title").text("Convert Data File"),d3.select("#mtm-modal-body").text(""),e.convertor("mtm-modal-body");else if(t=="examples"){d3.select("#mtm-modal-title").text("Example Data Files");var n=d3.select("#mtm-modal-body").text("").append("ul").attr("class","list-unstyled");n.append("li").append("label").text("#1. HuFS: Human gut - 30 years old male").attr("width","210px");var r=n.append("li").attr("class","btn-group");r.append("a").attr("href","http://www.ncbi.nlm.nih.gov/pubmed/17916580").attr("class","btn btn-default").attr("target","cite").text("Citation"),r.append("a").attr("href","http://metagenomics.anl.gov/metagenomics.cgi?page=MetagenomeOverview&metagenome=4525311.3").attr("class","btn btn-default").attr("target","rast").text("Data Source"),r.append("a").attr("href","./data/HuFS.json").attr("class","btn btn-default").attr("target","rast").text("Data File"),n.append("li").append("label").text("#2. HuFU: Human gut - 7 months old female").attr("width","210px"),r=n.append("li").attr("class","btn-group"),r.append("a").attr("href","http://www.ncbi.nlm.nih.gov/pubmed/17916580").attr("class","btn btn-default").attr("target","cite").text("Citation"),r.append("a").attr("href","http://metagenomics.anl.gov/metagenomics.cgi?page=MetagenomeOverview&metagenome=4525314.3").attr("class","btn btn-default").attr("target","rast").text("Data Source"),r.append("a").attr("href","./data/HuFU.json").attr("class","btn btn-default").attr("target","rast").text("Data File")}else if(t=="about"){d3.select("#mtm-modal-title").text("About MetaTreeMap");var n=d3.select("#mtm-modal-body").text("").append("ul").attr("class","list-unstyled"),r=n.append("li");r.append("strong").text("MetaTreeMap version "),r.append("strong").text(function(){return e.version}),r.append("strong").text(" is under the "),r.append("a").attr("href","./LICENSE").attr("target","_blank").text("BSD License");var r=n.append("li");r.append("strong").text("Development: "),r.append("a").attr("href","http://metasystems.riken.jp/wiki/Maxime_Hebrard").attr("target","_blank").text("Maxime Hebrard");var r=n.append("li");r.append("span").text("The following libraries are used, with thanks to their authors:");var i=r.append("ul");i.append("li").append("a").attr("href","https://d3js.org/").attr("target","_blank").text("D3"),i.append("li").append("a").attr("href","http://colorbrewer2.org/").attr("target","_blank").text("ColorBrewer2"),i.append("li").append("a").attr("href","https://jquery.com/").attr("target","_blank").text("jQuery"),i.append("li").append("a").attr("href","http://getbootstrap.com/").attr("target","_blank").text("Bootstrap"),i.append("li").append("a").attr("href","http://www.bootstraptoggle.com/").attr("target","_blank").text("Bootstrap Toggle"),i.append("li").append("a").attr("href","https://silviomoreto.github.io/bootstrap-select/").attr("target","_blank").text("Bootstrap-select"),i.append("li").append("a").attr("href","https://www.google.com/fonts/specimen/Source+Code+Pro").attr("target","_blank").text("Source Code Pro");var r=n.append("li");r.append("strong").text("Source code "),r.append("span").text("available on "),r.append("a").attr("href","https://github.com/mhebrard/MetaTreeMap").attr("target","_blank").text("GitHub");var r=n.append("li");r.append("strong").text("Download "),r.append("span").text("minified version "),r.append("a").attr("href","./mtm.min.js").attr("target","_blank").text("Here")}}function V(e){g.domain([e.x,e.x+e.dx]),y.domain([e.y,e.y+e.dy]);var t=r.options.zoom?1:v/e.dx,n=r.options.zoom?1:m/e.dy,i;r.options.hierarchy?i=h.nodes().filter(function(e){return e.parent&&t*e.dx-1>0&&n*e.dy-1>0}):i=h.nodes().filter(function(e){return!e.children&&t*e.dx-1>0&&n*e.dy-1>0});var s=d3.select(".mtm-treemap").select(".mtm-view").selectAll("rect").data(i,function(e){return e.id+e.data.sample});s.enter().insert("rect").attr("class",function(e){return"v"+e.id+e.data.sample}).style("stroke",function(){return r.options.background?"#000":"#FFF"}).style("fill",function(e){return e.data.color}).style("cursor","pointer").attr("transform","translate(0,0)").attr("width",0).attr("height",0).on("click",function(e){E==""&&(tt(e,!1),z("hide",e),nt(e))}).on("mouseover",function(e){tt(e,!0),z("show",e)}).on("mouseout",function(e){tt(e,!1),z("hide",e)}).on("mousemove",function(e){z("move")}).on("touchstart",W),s.transition().duration(1500).attr("transform",function(e){return"translate("+g(e.x)+","+y(e.y)+")"}).attr("width",function(e){return t*e.dx-1}).attr("height",function(e){return n*e.dy-1}),s.exit().remove()}function J(e){function c(e){var n,r,i,u,a=s*e.dx-1,f=o*e.dy-1;a<f?(n=g(e.x+e.dx/2),r=y(e.y)+t,i=n,u=y(e.y+e.dy)-t):(n=g(e.x)+t,r=y(e.y+e.dy/2),i=g(e.x+e.dx)-t,u=r);var l=d3.svg.line().x(function(e){return e[0]}).y(function(e){return e[1]}).interpolate("linear");return l([[n,r],[i,u]])}var t=Math.round(r.options.font*.6),i=Math.round(r.options.font*1.3),s=r.options.zoom?1:v/e.dx,o=r.options.zoom?1:m/e.dy,u=[],a=n.indexOf(r.options.labelled_rank);r.options.labelled!="no"&&(r.options.labelled=="rank"&&a!=-1?u=Z(a,e,e):u=h.nodes(e).filter(function(e){return!e.children})),u=u.filter(function(e){var n=s*e.dx-1,r=o*e.dy-1;if(n>0&&r>0&&(n<r&&n>i&&y(e.y+e.dy)-y(e.y)-2*t>0||n>r&&r>i&&g(e.x+e.dx)-g(e.x)-2*t>0))return e});var f=d3.select(".mtm-treemap").select(".mtm-labels").selectAll("path").data(u,function(e){return e.id+e.data.sample});f.enter().append("path").attr("id",function(e){return"map"+e.id+e.data.sample}).attr("d","M0,0L0,0").style("opacity",0).style("pointer-events","none"),f.transition().duration(1500).attr("d",function(e){return c(e)}),f.exit().remove();var f=d3.select(".mtm-treemap").select(".mtm-labels").selectAll("text").data(u,function(e){return e.id+e.data.sample});f.enter().append("text").attr("text-anchor","left").attr("dy","0.5ex").style("pointer-events","none").append("textPath").attr("xlink:href",function(e){return"#map"+e.id+e.data.sample}),f.selectAll("textPath").html(function(e){var t=r.options.pattern;return t=t.replace(/#N/g,e.name),t=t.replace(/#I/g,e.id),t=t.replace(/#H/g,at(e.data.hits)),t=t.replace(/#P/g,e.data.percent.toFixed(2)),t=t.replace(/#V/g,(e.value*100/l.value).toFixed(2)),t=t.replace(/#R/g,e.data.rank),t=t.replace(/#S/g,e.data.sample),t}),f.exit().remove()}function K(){var e=d3.select(".selectpicker").selectAll("option").data(c,function(e){return e.id});e.enter().append("option").attr("value",function(e,t){return t}).text(function(e){return e.name}),e.exit().remove(),d3.select(".selectpicker").insert("option",":first-child").attr("value",-1).property("selected",!0).text("Search..."),$(".selectpicker").selectpicker("refresh")}function Q(e){t&&console.time("growTable");var r=d3.select(".mtm-table").select(".mtm-view").html(""),i=it(e,[]);r.selectAll("tr").data(i).enter().append("tr").attr("class",function(e){return"v"+e.id+e.data.sample}).on("mouseover",function(e){tt(e,!0),z("show",e)}).on("mouseout",function(e){tt(e,!1),z("hide",e)}).on("mousemove",function(e){z("move")}).selectAll("td").data(["name","id","hits","percent","sample","rank"]).enter().append("td").attr("class",function(e){return e}),r.selectAll(".name").data(i).style("white-space","nowrap").style("overflow","hidden").style("text-overflow","ellipsis").style("cursor","pointer").append("span").style("padding-left",function(e){return+Math.max(e.depth,e.children?n.indexOf(e.data.rank):n.indexOf(e.data.rank)+1)*4+"px"}).html(function(e){return"<span class='glyphicon'>&nbsp;</span>"}).append("span").on("click",function(e){return tt(e,!1),rt(e)}).text(function(e){return e.name}),r.selectAll(".id").data(i).style("width","70px").style("text-align","right").append("span").filter(function(e){return+e.id>0}).append("a").attr("href",function(e){return"http://www.ncbi.nlm.nih.gov/Taxonomy/Browser/wwwtax.cgi?id="+e.id}).attr("target","taxonomy").text(function(e){return e.id}),r.selectAll(".hits").data(i).style("width","60px").style("text-align","right").append("span").text(function(e){return at(e.data.hits)}),r.selectAll(".percent").data(i).style("width","60px").style("text-align","right").append("span"),r.selectAll(".sample").data(i).style("width","90px").style("text-align","right").append("span").html(function(e){return e.data.percent.toFixed(2)+"%/"+e.data.sample+"&nbsp;"}),r.selectAll(".rank").data(i).style("width","130px").append("span").text(function(e){return e.data.rank}),r.selectAll("tr").filter(function(e){return e.children}).select(".glyphicon").on("click",function(e){return st(e)})}function G(){t&&console.time("updateColor"),rank=n.indexOf(r.options.colored_rank);var e;r.options.colored=="rank"&&rank!=-1?(Y(rank,i,i),r.options.cutoff_rank!="init"&&Y(rank,a,a),e=function(e){return e.data.color}):r.options.colored=="majority"?e=function(e){return e.children?e.data.color=p(e.data.count.indexOf(Math.max.apply(null,e.data.count))):e.data.color=p(e.parent.data.count.indexOf(Math.max.apply(null,e.parent.data.count))),e.data.color}:r.options.colored=="sample"?e=function(e){return e.data.color=p(e.data.sample),e.data.color}:e=function(e){return e.data.color=p(e.id),e.data.color},r.table.display&&d3.select(".mtm-table").select(".mtm-view").selectAll("tr").style("background-color",function(t){return e(t)}),r.treemap.display&&d3.select(".mtm-treemap").select(".mtm-view").selectAll("rect").style("fill",function(t){return e(t)})}function Y(e,t,i){if(i.children&&i.children.length>0)for(var s in i.children){var o=n.indexOf(i.children[s].data.rank);o>e?it(i.children[s],[]).forEach(function(e){e.data.color=p("sub"+i.id)}):o==e?it(i.children[s],[]).forEach(function(e){e.data.color=p(i.children[s].id)}):(r.options.upper?i.children[s].data.color=p(i.children[s].id):i.children[s].data.color="#ccc",Y(e,t,i.children[s]))}}function Z(e,t,r){var i=[];if(e<=n.indexOf(t.data.rank))i.push(t);else if(r.children&&r.children.length>0)for(var s in r.children){var o=n.indexOf(r.children[s].data.rank);o>=e?i.push(r.children[s]):i=i.concat(Z(e,t,r.children[s]))}else n.indexOf(r.data.rank)<e&&i.push(r);return i}function et(e,t,r){var i=[[],[],[]];if(r.children&&r.children.length>0)for(var s in r.children){var o=n.indexOf(r.children[s].data.rank);o>=e?(i[2]=i[2].concat(it(r.children[s],[])),i[0].push(r.children[s])):(i[1].push(r.children[s]),subList=et(e,t,r.children[s]),i[0]=i[0].concat(subList[0]),i[1]=i[1].concat(subList[1]),i[2]=i[2].concat(subList[2]))}return i}function tt(e,t){if(t){var n=v/l.dx,r=m/l.dy;d3.selectAll("rect.v"+e.id+e.data.sample).style("fill",function(e){return d3.hsl(e.data.color).darker(1)}),d3.selectAll("tr.v"+e.id+e.data.sample).style("background-color",function(e){return d3.hsl(e.data.color).darker(1)}),h.nodes().indexOf(e)>0&&(e.data.sample==0?d3.selectAll(".mtm-hl").attr("x",g(e.x)+1+2).attr("y",y(e.y)+20+2).attr("width",n*e.dx-5).attr("height",r*e.dy-5):d3.selectAll(".mtm-hl").attr("x",g(e.parent.x)+1+2).attr("y",y(e.parent.y)+20+2).attr("width",n*e.parent.dx-5).attr("height",r*e.parent.dy-5))}else d3.selectAll("rect.v"+e.id+e.data.sample).style("fill",function(e){return d3.hsl(e.data.color)}),d3.selectAll("tr.v"+e.id+e.data.sample).style("background-color",function(e){return d3.hsl(e.data.color)}),d3.selectAll(".mtm-hl").attr("x",0).attr("y",0).attr("width",0).attr("height",0)}function nt(e){e==l?e.parent&&(e.parent.data.hits==e.data.hits?(l=e.parent,nt(e.parent)):rt(e.parent)):e.children?e.children[0].data.hits==e.data.hits?nt(e.children[0]):rt(e):rt(e.parent)}function rt(e){l=e,e.parent?(d3.selectAll(".mtm-root").classed("mtm-on",!1),d3.selectAll(".mtm-root").classed("mtm-off",!0)):(d3.selectAll(".mtm-root").classed("mtm-on",!0),d3.selectAll(".mtm-root").classed("mtm-off",!1)),d3.select(".mtm-treemap").select(".mtm-header").datum(e).on("click",function(e){E==""&&(tt(e,!1),z("hide",e),nt(e))}).on("mouseover",function(e){tt(e,!1),z("show",e)}).on("mouseout",function(e){tt(e,!1),z("hide",e)}).on("mousemove",function(e){z("move")}).on("touchstart",W).select("text").text(function(e){return e.name}),r.options.zoom&&(D(e),G()),r.treemap.display&&(V(e),J(e));if(r.table.display){var n=d3.select(".mtm-table").select(".mtm-labels").selectAll("tr");n.selectAll(".percent").text("-"),n.data(it(e,[]),function(e){return"t"+e.id+e.data.sample}).selectAll(".percent").text(function(t){return(t.value*100/e.value).toFixed(2)+"%"});if(r.options.labelled=="rank"&&rank!=-1){var s=a?et(rank,a,a):et(rank,i,i);n.data(s[2],function(e){return"v"+e.id+e.data.sample}).style("display","none"),n.data(s[0],function(e){return"v"+e.id+e.data.sample}).style("display","table-row").select(".glyphicon").attr("class","glyphicon glyphicon-expand"),n.data(s[1],function(e){return"v"+e.id+e.data.sample}).style("display","table-row").select(".glyphicon").attr("class","glyphicon glyphicon-collapse-down")}else n.style("display","table-row").select(".glyphicon").attr("class","glyphicon glyphicon-collapse-down");n.filter(function(e){return!e.children}).select(".glyphicon").attr("class","glyphicon glyphicon-unchecked"),t&&console.timeEnd("setLabelTable")}}function it(e,t){return e!=i&&t.push(e),e.children&&e.children.forEach(function(e){t=it(e,t)}),t}function st(e){var t=d3.select(".mtm-table").select(".v"+e.id+e.data.sample).select(".glyphicon");if(t.classed("glyphicon glyphicon-collapse-down")){t.attr("class","glyphicon glyphicon-expand");if(e.children)for(var n in e.children)ot(e.children[n])}else{t.attr("class","glyphicon glyphicon-collapse-down");if(e.children)for(var n in e.children)ut(e.children[n])}}function ot(e){d3.select(".mtm-table").selectAll(".v"+e.id+e.data.sample).style("display","none");if(e.children)for(var t in e.children)ot(e.children[t])}function ut(e){var t=d3.select(".mtm-table").select(".v"+e.id+e.data.sample).style("display","table-row");if(t.select(".glyphicon").classed("glyphicon-collapse-down")&&e.children)for(var n in e.children)ut(e.children[n])}function at(e){return Number(e).toLocaleString("en")}function ft(e,t){if(e.children&&e.children.length>0){var n;t?e.data.hits==t.data.sum?(t.name=e.name,t.data.rank=e.data.rank,t.id=e.id,n=t):(n={name:e.name,children:[],data:{assigned:0,sum:e.data.hits,rank:e.data.rank},id:e.id},t.children.push(n)):(n={name:e.name,children:[],data:{assigned:0,sum:e.data.hits,rank:e.data.rank},id:e.id},out=n);for(var r in e.children)ft(e.children[r],n)}else t.data.assigned=t.data.assigned+e.data.hits}function lt(e,t){d3.select("#mtm-canvas").append("a").attr("download",e).attr("href",t).node().click()}function ct(e){var t=e.name+"	"+(+e.id>0?e.id:"")+"	"+e.data.hits+"	"+(e.data.hits*100/i.data.hits).toFixed(1)+"	"+e.data.sample+"	"+e.data.rank+"\n";if(e.children&&e.children.length>0)for(var n in e.children)t+=ct(e.children[n]);return t}function ht(e){e.value=="json"?(d3.select("#mtm-fieldhead").html("Object Property <small>(Specify field name in your dataset)<small>"),d3.select("[name=mtm-tid]").attr("value","id"),d3.select("[name=mtm-tname]").attr("value","name"),d3.select("[name=mtm-hits]").attr("value","data.assigned"),d3.select("#mtm-headrow").style("display","none")):e.value=="tab"&&(d3.select("#mtm-fieldhead").html("Column Index <small>(Specify the column of the field in your dataset)</small>"),d3.select("[name=mtm-tid]").attr("value","1"),d3.select("[name=mtm-tname]").attr("value","2"),d3.select("[name=mtm-hits]").attr("value","3"),d3.select("#mtm-headrow").style("display","table-row"))}function pt(){var e=d3.select("[name=mtm-format]:checked").node().value,t=d3.select("#mtm-convert").node().files[0];i={name:"root",children:[],data:{assigned:0,rank:"no rank"},id:1},o=[i.id],u=[i];var n=[];d3.text("./data/taxonomy.tsv",function(r){r.split("\n").forEach(function(e){var t=e.split("	");n[+t[0]]={id:+t[0],parent:+t[1],rank:t[2],name:t[3]}});if(e=="json"){var s=d3.select("[name=mtm-tid]").node().value.split("."),o=d3.select("[name=mtm-tname]").node().value.split("."),u=d3.select("[name=mtm-hits]").node().value.split(".");d3.json(URL.createObjectURL(t),function(e){vt(n,e,s,o,u),yt(e),mt(e);var r="data:text/json;charset=utf8;filename=output.json,"+encodeURIComponent(JSON.stringify(out));lt(t.name.replace(/.[^.]*$/,"")+"_metabin.json",r)})}else if(e=="tab"){var s=+d3.select("[name=mtm-tid]").node().value-1,o=+d3.select("[name=mtm-tname]").node().value-1,u=+d3.select("[name=mtm-hits]").node().value-1,a=d3.select("[name=mtm-head]").property("checked");d3.text(URL.createObjectURL(t),function(e){var r=e.split(/\r?\n/),f;a?f=1:f=0;for(f;f<r.length;f++)if(r[f]!=""){var l=r[f].split("	");l[s]==0&&(n[0]={id:l[o],parent:1,rank:"no rank",name:l[o]}),dt(n,l[s],l[u])}yt(i);var c="data:text/json;charset=utf8;filename=output.json,"+encodeURIComponent(JSON.stringify(i));lt(t.name.replace(/.[^.]*$/,"")+"_metabin.json",c)})}})}function dt(e,t,n){var r=e[t],i,s,a,f=o.indexOf(r.id);f>-1?(a=!1,i=u[f],i.data.assigned=n):(a=!0,i={name:r.name,children:[],data:{assigned:n,rank:r.rank},id:r.id},o.push(i.id),u.push(i));if(r.parent!=r.id){var f=o.indexOf(r.parent);f>-1?s=u[f]:s=dt(e,r.parent,0),a&&s.children.push(i)}return i}function vt(e,t,n,r,i){t.data||(t.data={}),t.data.assigned=gt(t,i),t.id=gt(t,n),+t.id==0||!e[+t.id]?(t.name=gt(t,r),t.data.rank="no rank"):(t.name=e[+t.id].name,t.data.rank=e[+t.id].rank);if(t.children.length>0)for(var s in t.children)vt(e,t.children[s],n,r,i)}function mt(e,t){var n={name:e.name,children:[],data:{assigned:e.data.assigned,sum:e.data.sum,rank:e.data.rank},id:e.id};t?t.children.push(n):out=n;for(var r in e.children)mt(e.children[r],n)}function gt(e,t){var n=0,r=e;while(t[n])r=r[t[n]],n++;return r}function yt(e){e.data.sum=+e.data.assigned;if(e.children.length>0)for(var t in e.children){var n=yt(e.children[t]);e.data.sum+=n}return+e.data.sum}var e={version:"3.0"},t=!1,n=["no rank","superkingdom","kingdom","subkingdom","superphylum","phylum","subphylum","superclass","class","subclass","infraclass","superorder","order","suborder","infraorder","parvorder","superfamily","family","subfamily","tribe","subtribe","genus","subgenus","species group","species subgroup","species","subspecies","varietas","forma"],r,i,o,u,a,f,l,c,h,p="",d=[["brewer","#8dd3c7,#ffffb3,#bebada,#fb8072,#80b1d3,#fdb462,#b3de69,#fccde5,#d9d9d9,#bc80bd,#ccebc5,#ffed6f"],["d3","#1f77b4,#aec7e8,#ff7f0e,#ffbb78,#2ca02c,#98df8a,#d62728,#ff9896,#9467bd,#c5b0d5,#8c564b,#c49c94,#e377c2,#f7b6d2,#7f7f7f,#c7c7c7,#bcbd22,#dbdb8d,#17becf,#9edae5"]],v=1,m=1,g,y,b=1,w=1,E="";e.load=function(t,n){if(!document.getElementById("mtm-mods")){var r=document.createElement("div");r.id="mtm-mods";var s=document.getElementsByTagName("body")[0];s.firstChild?s.insertBefore(r,s.firstChild):s.appendChild(r)}var o=[];window.jQuery?$.fn.modal.Constructor.VERSION||(o.push(x("https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css")),o.push(S("https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"))):(o.push(S("http://code.jquery.com/jquery-1.12.0.min.js")),o.push(x("https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css")),o.push(S("https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"))),window.d3||o.push(S("https://d3js.org/d3.v3.min.js")),Promise.resolve().then(function(){return Promise.all(o)}).catch(function(e){return Error("mtm.load.dependencies:",e)}).then(function(){console.log("mtm",e.version),console.log("jQ",jQuery.fn.jquery),console.log("bootstrap",$.fn.modal.Constructor.VERSION),console.log("d3",d3.version)}).catch(function(e){return Error("mtm.load.versions:",e)}).then(function(){return o=[],d3.select("#mtm-mods").attr("data-subs")||(d3.select("#mtm-mods").attr("data-subs",!0),o.push(x("http://fonts.googleapis.com/css?family=Source+Code+Pro:600")),o.push(x("https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css")),o.push(S("https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js")),o.push(x("https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.10.0/css/bootstrap-select.min.css")),o.push(S("https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.10.0/js/bootstrap-select.min.js"))),Promise.all(o)}).catch(function(e){return Error("mtm.load.modules:",e)}).then(function(){return T(n)}).catch(function(e){return Error("mtm.load.config:",e)}).then(function(){return Promise.all([A(),O()])}).catch(function(e){return Error("mtm.load.layout:",e)}).then(function(){return N(t)}).catch(function(e){return Error("mtm.load.data:",e)}).then(function(e){e[0]=e.reduce(function(e,t){return+e+ +t}),L(i,e),console.log("skeleton",i),M()})},e.save=function(e){d3.select("#mtm-canvas").html("");if(e=="json"){ft(i);var t="data:text/json;charset=utf8;filename=output.json,"+encodeURIComponent(JSON.stringify(out));lt("tree.json",t)}else if(e=="svg"){var n=d3.select("svg").attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").attr(":xmlns:xlink","http://www.w3.org/1999/xlink").node().outerHTML,t="data:image/svg+xml;charset=utf8;filename=treemap.svg,"+encodeURIComponent(n);lt("treemap.svg",t)}else if(e=="png"){var s=d3.select("svg"),o=d3.select("body").append("canvas").attr("width",s.attr("width")).attr("height",s.attr("height")).style("display","none").node(),u=o.getContext("2d"),n=s.attr("version",1.1).attr("xmlns","http://www.w3.org/2000/svg").attr(":xmlns:xlink","http://www.w3.org/1999/xlink").node().outerHTML,a=new Image;a.onload=function(){u.drawImage(a,0,0);var e=o.toDataURL().replace("image/png","application/octet-stream");lt("treemap.png",e)},a.src="data:image/svg+xml;base64,"+btoa(n)}else if(e=="txt"){var f="Name	TaxonomyID	Hits	Percentage	Sample	Rank\n";f+=ct(i);var t="data:text/tab-separated-values;charset=utf8;filename=table.txt,"+encodeURIComponent(f);lt("table.txt",t)}else if(e=="config"){var t="data:text/json;charset=utf8;filename=mtm-config.json,"+encodeURIComponent(JSON.stringify(r));lt("mtm-config.json",t)}},e.convertor=function(e){var t=d3.select("#"+e),n=t.append("form"),r=n.append("div").attr("class","form-inline").style("white-space","nowrap").style("overflow","hidden").style("text-overflow","ellipsis");r.append("label").text("Data File").style("width","90px"),s=r.append("label").attr("class","btn btn-default").attr("id","mtm-convert-data"),s.text("Browse..."),s.append("input").attr("type","file").style("display","none").attr("id","mtm-convert").attr("name","mtm-convertFile").on("change",function(){d3.select("#mtm-convert-help").text(this.files[0].name)}),$("#mtm-convert-data").on({click:function(){$("#"+e)[0].closable=!1}}),r.append("label").attr("class","help-block small").attr("id","mtm-convert-help").style("display","inline"),r=n.append("div").attr("class","form-inline"),r.append("label").text("Format").style("width","90px");var i=r.append("label").attr("class","radio-inline");i.append("input").attr("type","radio").property("checked",!0).attr("name","mtm-format").attr("value","json").on("click",function(){ht(this)}),i.append("span").text("Other JSON");var i=r.append("label").attr("class","radio-inline");i.append("input").attr("type","radio").attr("name","mtm-format").attr("value","tab").on("click",function(){ht(this)}),i.append("span").text("Tabular (TSV)"),r=n.append("div").attr("class","form-inline"),r.append("label").text("Fields").style("width","90px"),r.append("label").attr("id","mtm-fieldhead").html("Object Property <small>(Specify field name in your dataset)<small>"),r=n.append("div").attr("class","form-inline"),r.append("label").text("Taxon ID").style("width","90px"),r.append("input").attr("type","text").attr("class","form-control").attr("name","mtm-tid").attr("value","id"),r=n.append("div").attr("class","form-inline"),r.append("label").text("Taxon Name").style("width","90px"),r.append("input").attr("type","text").attr("class","form-control").attr("name","mtm-tname").attr("value","name"),r=n.append("div").attr("class","form-inline"),r.append("label").text("Hits").style("width","90px"),r.append("input").attr("type","text").attr("class","form-control").attr("name","mtm-hits").attr("value","data.assigned"),r=n.append("div").attr("class","form-inline").attr("id","mtm-headrow").style("display","none"),r.append("label").text("Header").style("width","90px");var i=r.append("label").attr("class","checkbox-inline");i.append("input").attr("type","checkbox").attr("name","mtm-head").attr("value","false"),i.append("span").text("Ignore 1st Line"),r=n.append("div").attr("class","form-inline"),r.append("button").attr("class","btn btn-primary").attr("type","button").style("width","90px").text("Convert").on("click",function(){pt()}),$("#"+e).on({"show.bs.modal":function(){this.closable=!0},"hide.bs.modal":function(){return this.closable?!0:(this.closable=!0,!1)}})},typeof define=="function"&&define.amd?define("mtm",e):typeof module=="object"&&module.exports&&(module.exports=e),this.mtm=e}();